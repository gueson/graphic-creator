<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è‡ªåª’ä½“å›¾æ–‡åˆ¶ä½œç¥å™¨</title>
  <!-- å¼•å…¥TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- å¼•å…¥html2canvas CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- å¼•å…¥Lucideå›¾æ ‡CDN -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <!-- å¼•å…¥åœ¨çº¿å­—ä½“ï¼ˆç½‘çº¢å­—ä½“ï¼‰ -->
  <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+SC:wght@400;700;900&family=Noto+Serif+SC:wght@400;700;900&family=ZCOOL+KuaiLe&family=ZCOOL+QingKe+HuangYou&family=ZCOOL+XiaoWei&family=Montserrat:wght@400;700&family=Oswald:wght@400;700&family=Poppins:wght@400;700&family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
  <!-- Plausible è®¿é—®ç»Ÿè®¡ï¼ˆæœ€ç®€æ–¹æ¡ˆï¼Œæ›¿æ¢ä¸ºä½ çš„åŸŸåï¼‰ -->
  <!-- <script defer data-domain="graphic-creator.vercel.app" src="https://plausible.io/js/script.js"></script> -->
   <script defer 
    data-domain="graphic-creator.vercel.app" 
    data-api="https://plausible.io/graphic-creator.vercel.app/api/event"
    src="https://plausible.io/graphic-creator.vercel.app/js/script.js">
  </script>
  <!-- Privacy-friendly analytics by Plausible -->
  <!-- <script async src="https://plausible.io/js/pa-yY76VIWcjLpfoNuUbxe2c.js"></script>
  <script>
    window.plausible=window.plausible||function(){(plausible.q=plausible.q||[]).push(arguments)},plausible.init=plausible.init||function(i){plausible.o=i||{}};
    plausible.init()
  </script> -->



  <!-- Tailwindé…ç½® -->
  <script>
    tailwind.config = {
      theme: {
        extend: {},
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .preview-container {
        max-height: 80vh;
        max-width: 100%;
        margin-bottom: 20px !important;
      }
    }
  </style>
  <style>
    /* åŸºç¡€æ ·å¼è¡¥å…… */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    * {
      box-sizing: inherit;
    }
    .text-pre-wrap {
      white-space: pre-wrap;
      word-break: break-all;
    }
    /* ä¿®å¤ä¸‹æ‹‰æ¡†é€‰ä¸­æ ·å¼ */
    select:focus {
      outline: 2px solid #3b82f6;
      outline-offset: 2px;
    }
    /* æœ¬åœ°ç¯å¢ƒå…¼å®¹æ ·å¼ */
    #tempRenderContainer {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      z-index: 9999 !important;
      opacity: 1 !important;
      pointer-events: none !important;
      width: auto !important;
      height: auto !important;
      overflow: visible !important;
    }
    /* é¢„è§ˆåŒºå›ºå®šä¸Šè¾¹è·ï¼Œå¼ºåˆ¶ä¸æ»šåŠ¨ */
    #previewArea {
      margin-top: 30px !important;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding-bottom: 20px;
    }
    #previewWrapper {
      max-width: calc(100vw - 40px) !important;
      max-height: calc(80vh - 120px) !important;
    }
    /* åé¦ˆå¼¹çª—æ ·å¼ */
    #contactModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      max-width: 90%;
      width: 400px;
      text-align: center;
    }
    .qrcode-img {
      width: 200px;
      height: 200px;
      margin: 1rem auto;
      border: 1px solid #eee;
      padding: 0.5rem;
    }
    .close-modal {
      position: absolute;
      top: 1rem;
      right: 1rem;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
    }
  </style>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <header class="sticky top-0 z-10 bg-white dark:bg-gray-800 shadow-sm px-4 py-3">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <h1 class="text-xl font-bold text-blue-600 dark:text-blue-400">è‡ªåª’ä½“å›¾æ–‡åˆ¶ä½œç¥å™¨</h1>
      <div class="flex gap-2">
        <button id="undoBtn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50" title="æ’¤é”€">
          <i data-lucide="undo" class="w-5 h-5"></i>
        </button>
        <button id="redoBtn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50" title="é‡åš">
          <i data-lucide="redo" class="w-5 h-5"></i>
        </button>
        <button id="previewFullscreenBtn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" title="å…¨å±é¢„è§ˆ">
          <i data-lucide="eye" class="w-5 h-5"></i>
        </button>
        <!-- æ–°å¢åé¦ˆ/è”ç³»æŒ‰é’® -->
        <button id="contactBtn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" title="åé¦ˆ/è”ç³»æˆ‘">
          <i data-lucide="message-square" class="w-5 h-5"></i>
        </button>
        <button id="downloadHighBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
          <i data-lucide="download" class="w-4.5 h-4.5"></i>
          ä¸‹è½½é«˜æ¸…å›¾
        </button>
      </div>
    </div>
  </header>

  <!-- åé¦ˆ/è”ç³»å¼¹çª— -->
  <div id="contactModal">
    <div class="modal-content relative">
      <span class="close-modal" id="closeModal">&times;</span>
      <h2 class="text-xl font-bold text-blue-600 mb-2">åé¦ˆ/è”ç³»æˆ‘</h2>
      <p class="text-gray-600 mb-3">æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿è”ç³»æˆ‘ï¼</p>
      <div class="mb-3">
        <p class="font-medium">ğŸ“§ é‚®ç®±ï¼šgueson1989@gmail.com</p>
      </div>
      <div>
        <p class="font-medium">ğŸ“± å¾®ä¿¡ç¾¤ï¼šæ‰«ç åŠ å…¥</p>
        <!-- æ›¿æ¢ä¸ºä½ çš„å¾®ä¿¡ç¾¤äºŒç»´ç å›¾ç‰‡åœ°å€ -->
        <img src="./images/group-chat.jpg" alt="å¾®ä¿¡ç¾¤äºŒç»´ç " class="qrcode-img">
        <p class="text-sm text-red-500 mt-1">è‹¥äºŒç»´ç å¤±æ•ˆï¼Œå¯é€šè¿‡ä¸Šæ–¹é‚®ç®±è”ç³»</p>
      </div>
    </div>
  </div>

  <main id="mainContent" class="max-w-7xl mx-auto p-4 md:p-6 flex flex-col md:flex-row gap-6">
    <!-- å·¦ä¾§ç¼–è¾‘åŒº -->
    <div class="w-full md:w-1/3 lg:w-1/4 space-y-6">
      <!-- å°ºå¯¸è®¾ç½® -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4">
        <h3 class="font-semibold mb-3 flex items-center gap-2">
          <i data-lucide="zoom-in" class="w-4.5 h-4.5"></i> å°ºå¯¸è®¾ç½®
        </h3>
        <select id="sizeSelect" class="w-full p-2 border border-gray-300 dark:border-gray-700 rounded-lg mb-3 bg-white dark:bg-gray-900">
          <option value="9:16" data-width="1080" data-height="1920">æŠ–éŸ³ç«–ç‰ˆ (9:16)</option>
          <option value="16:9" data-width="1920" data-height="1080">æŠ–éŸ³æ¨ªç‰ˆ (16:9)</option>
          <option value="3:4" data-width="1080" data-height="1440">å°çº¢ä¹¦ (3:4)</option>
          <option value="4:3" data-width="1080" data-height="810">å…¬ä¼—å·å°é¢ (4:3)</option>
          <option value="1:1" data-width="1080" data-height="1080">è§†é¢‘å· (1:1)</option>
          <option value="custom">è‡ªå®šä¹‰</option>
        </select>
        
        <div id="customSizeContainer" class="grid grid-cols-2 gap-3 hidden">
          <div>
            <label class="text-sm text-gray-600 dark:text-gray-400 mb-1 block">å®½åº¦(px)</label>
            <input type="number" id="customWidth" min="100" max="4096" value="1080" class="w-full p-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-900">
          </div>
          <div>
            <label class="text-sm text-gray-600 dark:text-gray-400 mb-1 block">é«˜åº¦(px)</label>
            <input type="number" id="customHeight" min="100" max="4096" value="1920" class="w-full p-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-900">
          </div>
        </div>
      </div>

      <!-- æ–‡æ¡ˆç¼–è¾‘ï¼ˆæ–°å¢20+ç½‘çº¢å­—ä½“ï¼‰ -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4">
        <h3 class="font-semibold mb-3 flex items-center gap-2">
          <i data-lucide="type" class="w-4.5 h-4.5"></i> æ–‡æ¡ˆè®¾ç½®
        </h3>
        <textarea id="textInput" placeholder="è¯·è¾“å…¥æ–‡æ¡ˆï¼ˆæ”¯æŒå¤šè¡Œï¼‰" class="w-full h-32 p-3 border border-gray-300 dark:border-gray-700 rounded-lg mb-3 bg-white dark:bg-gray-900 resize-none">è¯·è¾“å…¥ä½ çš„æ–‡æ¡ˆ
æ”¯æŒå¤šè¡Œæ¢è¡Œ</textarea>
        
        <div class="space-y-3">
          <div>
            <label class="text-sm text-gray-600 dark:text-gray-400 mb-1 block">å­—ä½“</label>
            <select id="fontSelect" class="w-full p-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-900">
              <!-- ç³»ç»ŸåŸºç¡€å­—ä½“ -->
              <option value="inherit">ç³»ç»Ÿé»˜è®¤</option>
              <option value="SimHei, sans-serif">é»‘ä½“</option>
              <option value="Microsoft YaHei, sans-serif">å¾®è½¯é›…é»‘</option>
              <option value="SimSun, serif">å®‹ä½“</option>
              <option value="KaiTi, serif">æ¥·ä½“</option>
              <option value="FangSong, serif">ä»¿å®‹</option>
              <option value="STSong, serif">å®‹ä½“-ç¹</option>
              <option value="STHeiti, sans-serif">é»‘ä½“-ç¹</option>
              
              <!-- ç½‘çº¢ä¸­æ–‡å­—ä½“ï¼ˆGoogle Fontsï¼‰ -->
              <option value="'Ma Shan Zheng', cursive" selected>é©¬å–„æ”¿ï¼ˆæ‰‹å†™é£ï¼‰</option>
              <option value="'ZCOOL KuaiLe', sans-serif">ç«™é…·å¿«ä¹ä½“ï¼ˆå¡é€šï¼‰</option>
              <option value="'ZCOOL QingKe HuangYou', sans-serif">ç«™é…·åº†ç§‘é»„æ²¹ä½“ï¼ˆåœ†æ¶¦ï¼‰</option>
              <option value="'ZCOOL XiaoWei', serif">ç«™é…·å°è–‡ä½“ï¼ˆä¼˜é›…ï¼‰</option>
              <option value="'Noto Sans SC', sans-serif">æ€æºé»‘ä½“ï¼ˆç™¾æ­ï¼‰</option>
              <option value="'Noto Sans SC', sans-serif; font-weight: 700">æ€æºé»‘ä½“-ç²—</option>
              <option value="'Noto Sans SC', sans-serif; font-weight: 900">æ€æºé»‘ä½“-é»‘</option>
              <option value="'Noto Serif SC', serif">æ€æºå®‹ä½“ï¼ˆå¤å¤ï¼‰</option>
              <option value="'Noto Serif SC', serif; font-weight: 700">æ€æºå®‹ä½“-ç²—</option>
              <option value="'Noto Serif SC', serif; font-weight: 900">æ€æºå®‹ä½“-é»‘</option>
              
              <!-- ç½‘çº¢è‹±æ–‡å­—ä½“ -->
              <option value="'Montserrat', sans-serif">Montserratï¼ˆç®€çº¦ï¼‰</option>
              <option value="'Montserrat', sans-serif; font-weight: 700">Montserrat-ç²—</option>
              <option value="'Oswald', sans-serif">Oswaldï¼ˆç¡¬æœ—ï¼‰</option>
              <option value="'Oswald', sans-serif; font-weight: 700">Oswald-ç²—</option>
              <option value="'Poppins', sans-serif">Poppinsï¼ˆæ—¶å°šï¼‰</option>
              <option value="'Poppins', sans-serif; font-weight: 700">Poppins-ç²—</option>
              <option value="'Roboto', sans-serif">Robotoï¼ˆç°ä»£ï¼‰</option>
              <option value="'Roboto', sans-serif; font-weight: 700">Roboto-ç²—</option>
              <option value="'Roboto', sans-serif; font-weight: 900">Roboto-é»‘</option>
              
              <!-- ç»å…¸ç½‘çº¢å­—ä½“ -->
              <option value="Arial Black, Gadget, sans-serif">Arial Blackï¼ˆç²—é»‘ï¼‰</option>
              <option value="Impact, Charcoal, sans-serif">Impactï¼ˆå†²å‡»åŠ›ï¼‰</option>
              <option value="Comic Sans MS, cursive, sans-serif">Comic Sansï¼ˆç«¥è¶£ï¼‰</option>
              <option value="Courier New, Courier, monospace">Courierï¼ˆå¤å¤æ‰“å­—æœºï¼‰</option>
            </select>
          </div>
          
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-sm text-gray-600 dark:text-gray-400 mb-1 block">å­—å·(px)</label>
              <input type="number" id="fontSize" min="12" max="120" value="48" class="w-full p-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-900">
            </div>
            <div>
              <label class="text-sm text-gray-600 dark:text-gray-400 mb-1 block">å¯¹é½æ–¹å¼</label>
              <select id="textAlign" class="w-full p-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-900">
                <option value="left">å·¦å¯¹é½</option>
                <option value="center" selected>å±…ä¸­</option>
                <option value="right">å³å¯¹é½</option>
              </select>
            </div>
          </div>
          
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-sm text-gray-600 dark:text-gray-400 mb-1 block">å­—ä½“é¢œè‰²</label>
              <input type="color" id="fontColor" value="#ffffff" class="w-full h-10 border border-gray-300 dark:border-gray-700 rounded-lg bg-transparent cursor-pointer">
            </div>
            <div>
              <label class="text-sm text-gray-600 dark:text-gray-400 mb-1 block">è¡Œé«˜</label>
              <input type="number" step="0.1" id="lineHeight" min="0.8" max="3" value="1.5" class="w-full p-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-900">
            </div>
          </div>
        </div>
      </div>

      <!-- èƒŒæ™¯è®¾ç½® -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4">
        <h3 class="font-semibold mb-3 flex items-center gap-2">
          <i data-lucide="palette" class="w-4.5 h-4.5"></i> èƒŒæ™¯è®¾ç½®
        </h3>
        
        <div class="space-y-3">
          <div>
            <label class="text-sm text-gray-600 dark:text-gray-400 mb-1 block">èƒŒæ™¯é¢œè‰²</label>
            <input type="color" id="bgColor" value="#000000" class="w-full h-10 border border-gray-300 dark:border-gray-700 rounded-lg bg-transparent cursor-pointer">
          </div>
          
          <div>
            <label class="text-sm text-gray-600 dark:text-gray-400 mb-1 block">èƒŒæ™¯å›¾ç‰‡</label>
            <div class="flex gap-2">
              <button id="uploadBgBtn" class="flex-1 p-2 border border-gray-300 dark:border-gray-700 rounded-lg flex items-center justify-center gap-2 hover:bg-gray-50 dark:hover:bg-gray-700">
                <i data-lucide="image" class="w-4 h-4"></i>
                ä¸Šä¼ å›¾ç‰‡
              </button>
              <input type="file" id="bgImageInput" accept="image/*" class="hidden">
              <button id="clearBgBtn" class="p-2 border border-red-300 dark:border-red-700 rounded-lg text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 hidden">
                æ¸…é™¤
              </button>
            </div>
          </div>
          
          <div id="bgModeContainer" class="hidden">
            <label class="text-sm text-gray-600 dark:text-gray-400 mb-1 block">å›¾ç‰‡æ˜¾ç¤ºæ¨¡å¼</label>
            <select id="bgMode" class="w-full p-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-900">
              <option value="cover" selected>æ‹‰ä¼¸è¦†ç›–</option>
              <option value="contain">ä¿æŒæ¯”ä¾‹</option>
              <option value="repeat">å¹³é“º</option>
            </select>
          </div>
        </div>
      </div>

      <!-- å¯¼å‡ºè®¾ç½® -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4">
        <h3 class="font-semibold mb-3">å¯¼å‡ºè®¾ç½®</h3>
        <div class="flex flex-col gap-3">
          <button id="downloadHighBtn2" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium">
            ä¸‹è½½é«˜æ¸…å›¾ç‰‡ (PNG)
          </button>
          <button id="downloadNormalBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg font-medium">
            ä¸‹è½½æ ‡æ¸…å›¾ç‰‡ (PNG)
          </button>
          <p class="text-xs text-gray-500 dark:text-gray-400 text-center">
            æ”¯æŒä¸»æµç¤¾äº¤å¹³å°å°ºå¯¸ï¼Œå¯¼å‡ºå›¾ç‰‡æ— æ°´å°
          </p>
        </div>
      </div>
    </div>

    <!-- å³ä¾§é¢„è§ˆåŒºï¼ˆä¿®å¤å›ºå®šä¸Šè¾¹è·+æ— éœ€æ»šåŠ¨ï¼‰ -->
    <div class="w-full md:w-2/3 lg:w-3/4" id="previewArea">
      <div class="mb-4 text-center w-full">
        <h2 class="text-lg font-semibold">å®æ—¶é¢„è§ˆ</h2>
        <p id="sizeInfo" class="text-sm text-gray-500 dark:text-gray-400">
          å°ºå¯¸: 1080px Ã— 1920px (9:16)
        </p>
      </div>
      
      <div class="w-full flex items-center justify-center preview-container">
        <div id="previewWrapper" class="border border-gray-200 dark:border-gray-700 rounded-xl shadow-lg overflow-hidden bg-white dark:bg-gray-800">
          <div id="canvasContainer" class="w-full h-full relative overflow-hidden" style="background-color: #000000;">
            <div id="textContainer" class="absolute inset-0 flex items-center justify-center p-8 text-pre-wrap" style="color: #ffffff; font-family: 'Ma Shan Zheng', cursive; font-size: 48px; text-align: center; line-height: 1.5;">
              è¯·è¾“å…¥ä½ çš„æ–‡æ¡ˆ
æ”¯æŒå¤šè¡Œæ¢è¡Œ
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- å…¨å±é¢„è§ˆ -->
  <div id="fullscreenPreview" class="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4 hidden">
    <button id="closeFullscreenBtn" class="absolute top-4 right-4 text-white bg-red-600 w-10 h-10 rounded-full flex items-center justify-center">
      Ã—
    </button>
    <div id="fullscreenCanvas" class="preview-container">
      <div class="w-full h-full relative overflow-hidden" style="background-color: #000000;">
        <div class="absolute inset-0 flex items-center justify-center p-8 text-pre-wrap" style="color: #ffffff; font-family: 'Ma Shan Zheng', cursive; font-size: 48px; text-align: center; line-height: 1.5;">
          è¯·è¾“å…¥ä½ çš„æ–‡æ¡ˆ
æ”¯æŒå¤šè¡Œæ¢è¡Œ
        </div>
      </div>
    </div>
  </div>

  <!-- æœ¬åœ°æ¸²æŸ“ä¸´æ—¶å®¹å™¨ -->
  <div id="tempRenderContainer"></div>

  <!-- åº•éƒ¨ -->
  <footer class="mt-10 py-4 text-center text-sm text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-800">
    è‡ªåª’ä½“å›¾æ–‡åˆ¶ä½œç¥å™¨ Â© 2025 | å…¼å®¹ç§»åŠ¨ç«¯/PCç«¯ | æ— æ°´å°å¯¼å‡º
    <!-- åº•éƒ¨ä¹Ÿå¯åŠ ä¸ªå°çš„åé¦ˆå…¥å£ -->
    <p class="mt-1 text-xs"><a href="javascript:document.getElementById('contactModal').style.display='flex'" class="text-blue-500 hover:underline">é—®é¢˜åé¦ˆ/è”ç³»ä½œè€…</a></p>
  </footer>

  <script>
    // åˆå§‹åŒ–å›¾æ ‡
    lucide.createIcons();

    // æ ¸å¿ƒçŠ¶æ€ç®¡ç†
    const state = {
      text: 'è¯·è¾“å…¥ä½ çš„æ–‡æ¡ˆ\næ”¯æŒå¤šè¡Œæ¢è¡Œ',
      selectedSize: { ratio: '9:16', width: 1080, height: 1920 },
      customWidth: 1080,
      customHeight: 1920,
      font: "'Ma Shan Zheng', cursive", // é»˜è®¤ç½‘çº¢å­—ä½“
      fontSize: 48,
      fontColor: '#ffffff',
      bgColor: '#000000',
      bgImage: null,
      bgMode: 'cover',
      textAlign: 'center',
      lineHeight: 1.5,
      previewFullscreen: false,
      history: [],
      historyIndex: -1
    };

    // DOMå…ƒç´ å¼•ç”¨
    const elements = {
      sizeSelect: document.getElementById('sizeSelect'),
      customSizeContainer: document.getElementById('customSizeContainer'),
      customWidth: document.getElementById('customWidth'),
      customHeight: document.getElementById('customHeight'),
      sizeInfo: document.getElementById('sizeInfo'),
      textInput: document.getElementById('textInput'),
      fontSelect: document.getElementById('fontSelect'),
      fontSize: document.getElementById('fontSize'),
      fontColor: document.getElementById('fontColor'),
      textAlign: document.getElementById('textAlign'),
      lineHeight: document.getElementById('lineHeight'),
      bgColor: document.getElementById('bgColor'),
      uploadBgBtn: document.getElementById('uploadBgBtn'),
      bgImageInput: document.getElementById('bgImageInput'),
      clearBgBtn: document.getElementById('clearBgBtn'),
      bgModeContainer: document.getElementById('bgModeContainer'),
      bgMode: document.getElementById('bgMode'),
      canvasContainer: document.getElementById('canvasContainer'),
      textContainer: document.getElementById('textContainer'),
      previewWrapper: document.getElementById('previewWrapper'),
      undoBtn: document.getElementById('undoBtn'),
      redoBtn: document.getElementById('redoBtn'),
      previewFullscreenBtn: document.getElementById('previewFullscreenBtn'),
      fullscreenPreview: document.getElementById('fullscreenPreview'),
      closeFullscreenBtn: document.getElementById('closeFullscreenBtn'),
      fullscreenCanvas: document.getElementById('fullscreenCanvas'),
      mainContent: document.getElementById('mainContent'),
      downloadHighBtn: document.getElementById('downloadHighBtn'),
      downloadHighBtn2: document.getElementById('downloadHighBtn2'),
      downloadNormalBtn: document.getElementById('downloadNormalBtn'),
      tempRenderContainer: document.getElementById('tempRenderContainer'),
      previewArea: document.getElementById('previewArea'),
      // æ–°å¢åé¦ˆç›¸å…³å…ƒç´ 
      contactBtn: document.getElementById('contactBtn'),
      contactModal: document.getElementById('contactModal'),
      closeModal: document.getElementById('closeModal')
    };

    // ä¿å­˜å†å²è®°å½•
    const saveHistory = () => {
      const currentState = {
        text: state.text,
        selectedSize: { ...state.selectedSize },
        customWidth: state.customWidth,
        customHeight: state.customHeight,
        font: state.font,
        fontSize: state.fontSize,
        fontColor: state.fontColor,
        bgColor: state.bgColor,
        bgImage: state.bgImage,
        bgMode: state.bgMode,
        textAlign: state.textAlign,
        lineHeight: state.lineHeight
      };
      const newHistory = state.history.slice(0, state.historyIndex + 1);
      state.history = [...newHistory, currentState];
      state.historyIndex = newHistory.length;
      updateHistoryButtons();
    };

    // æ›´æ–°æ’¤é”€/é‡åšæŒ‰é’®çŠ¶æ€
    const updateHistoryButtons = () => {
      elements.undoBtn.disabled = state.historyIndex <= 0;
      elements.redoBtn.disabled = state.historyIndex >= state.history.length - 1;
    };

    // æ’¤é”€
    const handleUndo = () => {
      if (state.historyIndex > 0) {
        const prevState = state.history[state.historyIndex - 1];
        Object.assign(state, prevState);
        renderAll();
        state.historyIndex--;
        updateHistoryButtons();
      }
    };

    // é‡åš
    const handleRedo = () => {
      if (state.historyIndex < state.history.length - 1) {
        const nextState = state.history[state.historyIndex + 1];
        Object.assign(state, nextState);
        renderAll();
        state.historyIndex++;
        updateHistoryButtons();
      }
    };

    // è·å–å½“å‰å°ºå¯¸
    const getCurrentSize = () => {
      if (state.selectedSize.ratio === 'custom') {
        return { 
          width: parseInt(state.customWidth), 
          height: parseInt(state.customHeight),
          ratio: `${state.customWidth}:${state.customHeight}`
        };
      }
      return { 
        width: state.selectedSize.width, 
        height: state.selectedSize.height,
        ratio: state.selectedSize.ratio
      };
    };

    // æ›´æ–°å°ºå¯¸ä¿¡æ¯å’Œé¢„è§ˆå®¹å™¨å¤§å°ï¼ˆå¼ºåˆ¶å›ºå®šä¸Šè¾¹è·ï¼Œæ— éœ€æ»šåŠ¨ï¼‰
    const updateSizeInfo = () => {
      const { width, height, ratio } = getCurrentSize();
      elements.sizeInfo.textContent = `å°ºå¯¸: ${width}px Ã— ${height}px (${ratio})`;
      
      // å¼ºåˆ¶é™åˆ¶é¢„è§ˆæ¡†å¤§å°ï¼Œç¡®ä¿æ— éœ€æ»šåŠ¨
      const maxWidth = window.innerWidth * 0.8;
      const maxHeight = window.innerHeight * 0.6; // è¿›ä¸€æ­¥ç¼©å°é«˜åº¦ï¼Œé¿å…æ»šåŠ¨
      const aspectRatio = width / height;
      let displayWidth, displayHeight;
      
      if (aspectRatio >= 1) {
        // æ¨ªç‰ˆ
        displayWidth = Math.min(maxWidth, maxHeight * aspectRatio);
        displayHeight = displayWidth / aspectRatio;
      } else {
        // ç«–ç‰ˆ
        displayHeight = Math.min(maxHeight, maxWidth / aspectRatio);
        displayWidth = displayHeight * aspectRatio;
      }
      
      // å¼ºåˆ¶è®¾ç½®é¢„è§ˆæ¡†å¤§å°ï¼Œå›ºå®šä¸Šè¾¹è·100px
      elements.previewWrapper.style.width = `${displayWidth}px`;
      elements.previewWrapper.style.height = `${displayHeight}px`;
      elements.canvasContainer.style.width = `${displayWidth}px`;
      elements.canvasContainer.style.height = `${displayHeight}px`;
      elements.fullscreenCanvas.style.width = `${Math.min(window.innerWidth * 0.9, width)}px`;
      elements.fullscreenCanvas.style.height = `${Math.min(window.innerHeight * 0.9, height)}px`;
      
      // å¼ºåˆ¶è®¾ç½®é¢„è§ˆåŒºä¸Šè¾¹è·
      elements.previewArea.style.marginTop = '100px';
    };

    // æ¸²æŸ“æ‰€æœ‰å†…å®¹
    const renderAll = () => {
      updateFormValues();
      updateSizeInfo();
      updateCanvasStyle();
      updateFullscreenPreview();
    };

    // æ›´æ–°è¡¨å•å€¼
    const updateFormValues = () => {
      elements.sizeSelect.value = state.selectedSize.ratio;
      elements.customWidth.value = state.customWidth;
      elements.customHeight.value = state.customHeight;
      elements.customSizeContainer.style.display = state.selectedSize.ratio === 'custom' ? 'grid' : 'none';
      
      elements.textInput.value = state.text;
      elements.fontSelect.value = state.font;
      elements.fontSize.value = state.fontSize;
      elements.fontColor.value = state.fontColor;
      elements.textAlign.value = state.textAlign;
      elements.lineHeight.value = state.lineHeight;
      
      elements.bgColor.value = state.bgColor;
      elements.clearBgBtn.style.display = state.bgImage ? 'block' : 'none';
      elements.bgModeContainer.style.display = state.bgImage ? 'block' : 'none';
      elements.bgMode.value = state.bgMode;
    };

    // æ›´æ–°ç”»å¸ƒæ ·å¼
    const updateCanvasStyle = () => {
      elements.canvasContainer.style.backgroundColor = state.bgColor;
      elements.canvasContainer.style.backgroundImage = state.bgImage ? `url(${state.bgImage})` : 'none';
      elements.canvasContainer.style.backgroundSize = state.bgMode === 'cover' ? 'cover' : state.bgMode === 'contain' ? 'contain' : 'repeat';
      elements.canvasContainer.style.backgroundPosition = 'center';
      elements.canvasContainer.style.backgroundRepeat = state.bgMode === 'repeat' ? 'repeat' : 'no-repeat';
      
      // å¤„ç†å­—ä½“æ ·å¼ï¼ˆå…¼å®¹weightï¼‰
      const fontParts = state.font.split(';');
      const fontFamily = fontParts[0].trim();
      const fontWeight = fontParts.length > 1 ? fontParts[1].replace('font-weight:', '').trim() : '400';
      
      // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼Œç¡®ä¿é¢„è§ˆæ•ˆæœä¸å®é™…å¯¼å‡ºä¸€è‡´
      const { width } = getCurrentSize();
      const displayWidth = parseInt(elements.canvasContainer.style.width);
      const scaleFactor = displayWidth / width;
      console.log('ç¼©æ”¾æ¯”ä¾‹:', scaleFactor);
      
      // æ ¹æ®ç¼©æ”¾æ¯”ä¾‹è°ƒæ•´æ–‡æœ¬æ ·å¼
      elements.textContainer.style.color = state.fontColor;
      elements.textContainer.style.fontFamily = fontFamily;
      elements.textContainer.style.fontWeight = fontWeight;
      elements.textContainer.style.fontSize = `${state.fontSize * scaleFactor}px`;
      elements.textContainer.style.textAlign = state.textAlign;
      elements.textContainer.style.lineHeight = state.lineHeight;
      elements.textContainer.style.padding = `${2 * scaleFactor}rem`; // æŒ‰æ¯”ä¾‹è°ƒæ•´å†…è¾¹è·
      elements.textContainer.textContent = state.text;
    };

    // æ›´æ–°å…¨å±é¢„è§ˆ
    const updateFullscreenPreview = () => {
      const fullscreenContent = elements.fullscreenCanvas.querySelector('div');
      if (fullscreenContent) {
        const textContent = fullscreenContent.querySelector('div');
        if (textContent) {
          fullscreenContent.style.backgroundColor = state.bgColor;
          fullscreenContent.style.backgroundImage = state.bgImage ? `url(${state.bgImage})` : 'none';
          fullscreenContent.style.backgroundSize = state.bgMode === 'cover' ? 'cover' : state.bgMode === 'contain' ? 'contain' : 'repeat';
          fullscreenContent.style.backgroundPosition = 'center';
          fullscreenContent.style.backgroundRepeat = state.bgMode === 'repeat' ? 'repeat' : 'no-repeat';
          
          // å¤„ç†å­—ä½“æ ·å¼
          const fontParts = state.font.split(';');
          const fontFamily = fontParts[0].trim();
          const fontWeight = fontParts.length > 1 ? fontParts[1].replace('font-weight:', '').trim() : '400';
          
          textContent.style.color = state.fontColor;
          textContent.style.fontFamily = fontFamily;
          textContent.style.fontWeight = fontWeight;
          textContent.style.fontSize = `${state.fontSize}px`;
          textContent.style.textAlign = state.textAlign;
          textContent.style.lineHeight = state.lineHeight;
          textContent.textContent = state.text;
        }
      }
    };

    // å¤„ç†èƒŒæ™¯å›¾ç‰‡ä¸Šä¼ 
    const handleBgImageUpload = (e) => {
      const file = e.target.files?.[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          state.bgImage = event.target?.result;
          saveHistory();
          renderAll();
        };
        reader.readAsDataURL(file);
      }
    };

    // æ¸…é™¤èƒŒæ™¯å›¾ç‰‡
    const handleClearBg = () => {
      state.bgImage = null;
      saveHistory();
      renderAll();
    };

    // ä¸‹è½½å›¾ç‰‡
    const handleDownload = async (quality = 'high') => {
      elements.downloadHighBtn.disabled = true;
      elements.downloadHighBtn2.disabled = true;
      elements.downloadNormalBtn.disabled = true;
      
      try {
        console.log('=== å¼€å§‹ä¸‹è½½å›¾ç‰‡ ===');
        console.log('è´¨é‡:', quality);
        
        // è·å–å½“å‰å°ºå¯¸
        const { width, height } = getCurrentSize();
        console.log('å½“å‰å°ºå¯¸:', width, height);
        
        // æ ¹æ®è´¨é‡è®¾ç½®ç¼©æ”¾æ¯”ä¾‹
        const scale = quality === 'high' ? 2 : 1;
        console.log('ç¼©æ”¾æ¯”ä¾‹:', scale);
        
        // åˆ›å»ºä¸€ä¸ªæ–°çš„å¯è§å®¹å™¨ï¼Œç”¨äºæ¸²æŸ“
        const renderContainer = document.createElement('div');
        
        // è®¾ç½®å®¹å™¨æ ·å¼
        renderContainer.style.position = 'fixed';
        renderContainer.style.top = '0';
        renderContainer.style.left = '0';
        renderContainer.style.zIndex = '9999';
        renderContainer.style.width = `${width}px`;
        renderContainer.style.height = `${height}px`;
        renderContainer.style.backgroundColor = state.bgColor;
        renderContainer.style.backgroundImage = state.bgImage ? `url(${state.bgImage})` : 'none';
        renderContainer.style.backgroundSize = state.bgMode;
        renderContainer.style.backgroundPosition = 'center';
        renderContainer.style.backgroundRepeat = state.bgMode === 'repeat' ? 'repeat' : 'no-repeat';
        renderContainer.style.overflow = 'hidden';
        renderContainer.style.opacity = '0.99'; // å‡ ä¹é€æ˜ï¼Œä½†å¯è§ä»¥ç¡®ä¿æ¸²æŸ“
        
        // æ·»åŠ åˆ°æ–‡æ¡£ä¸­
        document.body.appendChild(renderContainer);
        console.log('æ¸²æŸ“å®¹å™¨å·²æ·»åŠ åˆ°æ–‡æ¡£');
        
        // åˆ›å»ºæ–‡æœ¬å®¹å™¨
        const textContainer = document.createElement('div');
        
        // è§£æå­—ä½“æ ·å¼
        const fontParts = state.font.split(';');
        const fontFamily = fontParts[0].trim();
        const fontWeight = fontParts.length > 1 ? fontParts[1].replace('font-weight:', '').trim() : '400';
        
        // è®¾ç½®æ–‡æœ¬å®¹å™¨æ ·å¼
        textContainer.style.position = 'absolute';
        textContainer.style.inset = '0';
        textContainer.style.display = 'flex';
        textContainer.style.alignItems = 'center';
        textContainer.style.justifyContent = 'center';
        textContainer.style.padding = '2rem';
        textContainer.style.color = state.fontColor;
        textContainer.style.fontFamily = fontFamily;
        textContainer.style.fontWeight = fontWeight;
        textContainer.style.fontSize = `${state.fontSize}px`;
        textContainer.style.textAlign = state.textAlign;
        textContainer.style.lineHeight = state.lineHeight;
        textContainer.style.whiteSpace = 'pre-wrap';
        textContainer.style.wordBreak = 'break-all';
        textContainer.textContent = state.text;
        
        // æ·»åŠ åˆ°æ¸²æŸ“å®¹å™¨
        renderContainer.appendChild(textContainer);
        console.log('æ–‡æœ¬å®¹å™¨å·²æ·»åŠ åˆ°æ¸²æŸ“å®¹å™¨');
        console.log('æ–‡æœ¬å†…å®¹:', state.text);
        
        // ç­‰å¾…æ ·å¼å’Œå­—ä½“åŠ è½½
        await new Promise(resolve => setTimeout(resolve, 300));
        
        console.log('=== å¼€å§‹è°ƒç”¨html2canvas ===');
        const canvas = await html2canvas(renderContainer, {
          scale: scale,
          useCORS: true,
          allowTaint: true,
          logging: true,
          backgroundColor: state.bgColor,
          foreignObjectRendering: true,
          removeContainer: false
        });
        console.log('=== html2canvasè°ƒç”¨æˆåŠŸ ===');
        console.log('ç”»å¸ƒå°ºå¯¸:', canvas.width, canvas.height);
        
        // ä»æ–‡æ¡£ä¸­ç§»é™¤æ¸²æŸ“å®¹å™¨
        document.body.removeChild(renderContainer);
        console.log('æ¸²æŸ“å®¹å™¨å·²ä»æ–‡æ¡£ä¸­ç§»é™¤');

        // ç®€åŒ–ä¸‹è½½é€»è¾‘ï¼Œç›´æ¥ä½¿ç”¨toDataURL
        console.log('=== å¼€å§‹ç”Ÿæˆå›¾ç‰‡ ===');
        const dataUrl = canvas.toDataURL('image/png', quality === 'high' ? 1.0 : 0.8);
        console.log('=== å›¾ç‰‡ç”ŸæˆæˆåŠŸ ===');
        
        const link = document.createElement('a');
        link.download = `è‡ªåª’ä½“å›¾æ–‡_${Date.now()}_${quality === 'high' ? 'é«˜æ¸…' : 'æ ‡æ¸…'}.png`;
        link.href = dataUrl;
        link.click();
        
        console.log('=== ä¸‹è½½å®Œæˆ ===');
        // alert(`âœ… ${quality === 'high' ? 'é«˜æ¸…' : 'æ ‡æ¸…'}å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼`);
        
      } catch (error) {
        console.error('=== ä¸‹è½½å¤±è´¥ ===', error);
        alert(`âŒ ä¸‹è½½å¤±è´¥ï¼Œè¯·å°è¯•ï¼š
1. æ›´æ¢æµè§ˆå™¨ï¼ˆæ¨èChrome/Edgeï¼‰
2. å…³é—­æµè§ˆå™¨éšç§æ¨¡å¼
3. ç¡®ä¿é¢„è§ˆå†…å®¹ä¸ä¸ºç©º`);
      } finally {
        elements.downloadHighBtn.disabled = false;
        elements.downloadHighBtn2.disabled = false;
        elements.downloadNormalBtn.disabled = false;
      }
    };

    // åˆ‡æ¢å…¨å±é¢„è§ˆ
    const toggleFullscreenPreview = () => {
      state.previewFullscreen = !state.previewFullscreen;
      elements.fullscreenPreview.style.display = state.previewFullscreen ? 'flex' : 'none';
      elements.mainContent.style.display = state.previewFullscreen ? 'none' : 'flex';
      updateFullscreenPreview();
    };

    // æ–°å¢ï¼šåé¦ˆå¼¹çª—æ§åˆ¶
    const toggleContactModal = () => {
      elements.contactModal.style.display = elements.contactModal.style.display === 'flex' ? 'none' : 'flex';
    };

    // ç»‘å®šäº‹ä»¶ç›‘å¬
    const bindEvents = () => {
      // å°ºå¯¸é€‰æ‹©å˜åŒ–
      elements.sizeSelect.addEventListener('change', (e) => {
        const selectedValue = e.target.value;
        if (selectedValue === 'custom') {
          state.selectedSize = { ratio: 'custom', width: 0, height: 0 };
          elements.customSizeContainer.style.display = 'grid';
        } else {
          const selectedOption = e.target.options[e.target.selectedIndex];
          const width = parseInt(selectedOption.dataset.width);
          const height = parseInt(selectedOption.dataset.height);
          state.selectedSize = {
            ratio: selectedValue,
            width: width,
            height: height
          };
          state.customWidth = width;
          state.customHeight = height;
          elements.customSizeContainer.style.display = 'none';
        }
        saveHistory();
        renderAll();
      });

      // è‡ªå®šä¹‰å°ºå¯¸å˜åŒ–
      elements.customWidth.addEventListener('change', (e) => {
        state.customWidth = parseInt(e.target.value);
        saveHistory();
        renderAll();
      });
      elements.customHeight.addEventListener('change', (e) => {
        state.customHeight = parseInt(e.target.value);
        saveHistory();
        renderAll();
      });

      // æ–‡æ¡ˆå˜åŒ–
      elements.textInput.addEventListener('input', (e) => {
        state.text = e.target.value;
        saveHistory();
        renderAll();
      });

      // å­—ä½“è®¾ç½®å˜åŒ–ï¼ˆå…¼å®¹å¸¦weightçš„å­—ä½“ï¼‰
      elements.fontSelect.addEventListener('change', (e) => {
        state.font = e.target.value;
        saveHistory();
        renderAll();
      });
      elements.fontSize.addEventListener('change', (e) => {
        state.fontSize = parseInt(e.target.value);
        saveHistory();
        renderAll();
      });
      elements.fontColor.addEventListener('change', (e) => {
        state.fontColor = e.target.value;
        saveHistory();
        renderAll();
      });
      elements.textAlign.addEventListener('change', (e) => {
        state.textAlign = e.target.value;
        saveHistory();
        renderAll();
      });
      elements.lineHeight.addEventListener('change', (e) => {
        state.lineHeight = parseFloat(e.target.value);
        saveHistory();
        renderAll();
      });

      // èƒŒæ™¯è®¾ç½®å˜åŒ–
      elements.bgColor.addEventListener('change', (e) => {
        state.bgColor = e.target.value;
        saveHistory();
        renderAll();
      });
      elements.uploadBgBtn.addEventListener('click', () => {
        elements.bgImageInput.click();
      });
      elements.bgImageInput.addEventListener('change', handleBgImageUpload);
      elements.clearBgBtn.addEventListener('click', handleClearBg);
      elements.bgMode.addEventListener('change', (e) => {
        state.bgMode = e.target.value;
        saveHistory();
        renderAll();
      });

      // å†å²è®°å½•
      elements.undoBtn.addEventListener('click', handleUndo);
      elements.redoBtn.addEventListener('click', handleRedo);

      // å…¨å±é¢„è§ˆ
      elements.previewFullscreenBtn.addEventListener('click', toggleFullscreenPreview);
      elements.closeFullscreenBtn.addEventListener('click', toggleFullscreenPreview);

      // ä¸‹è½½
      elements.downloadHighBtn.addEventListener('click', () => handleDownload('high'));
      elements.downloadHighBtn2.addEventListener('click', () => handleDownload('high'));
      elements.downloadNormalBtn.addEventListener('click', () => handleDownload('normal'));

      // çª—å£å¤§å°å˜åŒ–ï¼ˆå¼ºåˆ¶é‡ç»˜é¢„è§ˆæ¡†ï¼‰
      window.addEventListener('resize', () => {
        updateSizeInfo();
        // å¼ºåˆ¶æ»šåŠ¨åˆ°é¢„è§ˆåŒºé¡¶éƒ¨
        elements.previewArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });

      // æ–°å¢ï¼šåé¦ˆå¼¹çª—äº‹ä»¶
      elements.contactBtn.addEventListener('click', toggleContactModal);
      elements.closeModal.addEventListener('click', toggleContactModal);
      // ç‚¹å‡»å¼¹çª—å¤–å±‚å…³é—­
      elements.contactModal.addEventListener('click', (e) => {
        if (e.target === elements.contactModal) toggleContactModal();
      });
    };

    // åˆå§‹åŒ–
    const init = () => {
      saveHistory();
      bindEvents();
      renderAll();
      // åˆå§‹åŒ–æ—¶å¼ºåˆ¶è®¾ç½®ä¸Šè¾¹è·
      elements.previewArea.style.marginTop = '100px';
    };

    // å¯åŠ¨åº”ç”¨
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
